<!DOCTYPE html>
<html lang="en">
<head>
  <title>Wellness Tracker</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">
    const content = document.querySelector('#content');

    const parseJSON = (xhr, content) => {
      //parse response (obj will be empty in a 204 updated)
      const obj = JSON.parse(xhr.response);
      if(obj.message) {
        const p = document.createElement('p');
        p.textContent = `${obj.message}`;
        content.appendChild(p);
      }
        
      if(obj.foods) {
        const foodList = document.createElement('ul');
        const foodObj = obj.foods;
        for (const [key, value] of Object.entries(foodObj)) {
            //console.log(`${key}: ${value}`);
            //console.dir(value);
            let foodListItem = document.createElement('li');
            foodListItem.innerHTML = "<b>" + value.foodName + ":</b> " + value.quantity + " @ " + value.calories + " calories each";
            foodList.appendChild(foodListItem);
            }
        content.appendChild(foodList);
      }
        
    if(obj.exercises) {
        const exerciseList = document.createElement('ul');
        const exerciseObj = obj.exercises;
        for (const [key, value] of Object.entries(exerciseObj)) {
            let exerciseListItem = document.createElement('li');
            exerciseListItem.innerHTML = "<b>" + value.exerciseType + ":</b> for " + value.duration + " minutes";
            exerciseList.appendChild(exerciseListItem);
            }
        exerciseContent.appendChild(exerciseList);
      }
    };

    //function to handle our response
    const handleResponse = (xhr, parseResponse) => {
      switch(xhr.status) {
        case 200: //success
          //just show the list
          //content.innerHTML = `<b>Success</b>`;
          break;
        case 201: //created
          content.innerHTML = '<b>Added to log!</b>';
          break;
        case 204: //updated (no response back from server)
          content.innerHTML = '<b>Log updated!</b>';
          return;
        case 400: //bad request
          content.innerHTML = `<b>Bad Request</b>`;
          break;
        case 404: //not found
          content.innerHTML = `<b>Not Found</b>`;
          break;
        default: //our default is not found, but just keeping this in case
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }
     //parse response - only parse if it's NOT a header request
        if(parseResponse) {
            parseJSON(xhr, content);
        }
    };

    //function to send our post request
    const sendPost = (e, foodForm) => {
      //grab the forms action (url to go to)
      //and method (HTTP method - POST in this case)
      const foodAction = foodForm.getAttribute('action');
      const foodMethod = foodForm.getAttribute('method');
      
      //grab the form's name and age fields so we can check user input
      const foodNameField = foodForm.querySelector('#foodNameField');
      const caloriesField = foodForm.querySelector('#caloriesField');
      const quantityField = foodForm.querySelector('#quantityField');
      
      //create a new Ajax request (remember this is asynchronous)
      const xhr = new XMLHttpRequest();
      xhr.open(foodMethod, foodAction);
      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader ('Accept', 'application/json');
      xhr.onload = () => handleResponse(xhr, true);
      
      //build our x-www-form-urlencoded format.
      //query string format: key=value&key2=value2
      const formData = `foodName=${foodNameField.value}&calories=${caloriesField.value}&quantity=${quantityField.value}`;
      
      //send our request with the data
      xhr.send(formData);
      if(e) {
          e.preventDefault();
      }
      //clear the fields in form when done
        foodForm.reset();
        //set focus back to first input
        foodForm.elements[0].focus();
        content.style.display="block";
      return false;
    };

    const sendPostExercise = (e, exerciseForm) => {
      const exerciseAction = exerciseForm.getAttribute('action');
      const exerciseMethod = exerciseForm.getAttribute('method');
      
      //grab the form's name and age fields so we can check user input
      const exerciseTypeField = exerciseForm.querySelector('#exerciseTypeField');
      const minutesField = exerciseForm.querySelector('#minutesField');
      
      //create a new Ajax request (remember this is asynchronous)
      const xhr = new XMLHttpRequest();
      xhr.open(exerciseMethod, exerciseAction);
      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader ('Accept', 'application/json');
      xhr.onload = () => handleResponse(xhr, true);
        
      const exerciseFormData = `exerciseType=${exerciseTypeField.value}&duration=${minutesField.value}`;
      
      //send our request with the data
      xhr.send(exerciseFormData);
      if(e) {
          e.preventDefault();
      }
        exerciseForm.reset();
        exerciseForm.elements[0].focus();
        exerciseContent.style.display="block";
      return false;
    };

    const requestUpdate = (e, foodForm) => {
      const url = foodForm.querySelector('#urlField').value;
      const method = foodForm.querySelector('#methodSelect').value;
      const xhr = new XMLHttpRequest();
      xhr.open(method, url); 
      xhr.setRequestHeader('Accept', 'application/json');

      if(method == 'get') {
        //if getting data, parse request to get json
        xhr.onload = () => handleResponse(xhr, true);
      } else {
        // HEAD request for no parse, no body responses
        // set onload to check meta data and NOT message
        xhr.onload = () => handleResponse(xhr, false);
      }
      xhr.send();
      e.preventDefault();
      return false;
    };

    const init = () => {
      //grab form
      const foodForm = document.querySelector('#foodForm');
      const addFoodBtn = document.querySelector("#addFoodBtn");
      const getFoodBtn = document.querySelector("#getFoodBtn");
      const exerciseForm = document.querySelector("#exerciseForm");
      const addExerciseBtn = document.querySelector("#addExerciseBtn");
      const getExerciseBtn = document.querySelector("#getExerciseBtn");
        
      //set up to see if enter key is hit on the form
      for(let i=0; i<foodForm.elements.length; i++) {
          let inputField = foodForm.elements[i];
          inputField.addEventListener("keydown", function(e) {
             if(e.keyCode === 13) {
                 addFood();
             } 
          });
      }
      for(let i=0; i<exerciseForm.elements.length; i++) {
          let inputField = exerciseForm.elements[i];
          inputField.addEventListener("keydown", function(e) {
             if(e.keyCode === 13) {
                 addExercise();
             } 
          });
      }
        
      //create handler
      const addFood = (e) => sendPost(e, foodForm);
      addFoodBtn.addEventListener("click", addFood);
      let displayList = true;
      const getFoods = (e) => {
          if(displayList) {
          //clear what's in the content so all they see is the list
          content.innerHTML="";
          requestUpdate(e, getForm);
          foodForm.style.display="none";
          content.style.display="block";
          e.target.value="Back to Main";
          addFoodBtn.disabled = true;
          displayList = false;
          }
          else {
              foodForm.style.display="block";
              content.style.display="none";
              addFoodBtn.disabled = false;
              e.target.value="Show List";
              displayList = true;
          }
      };
      getFoodBtn.addEventListener("click", getFoods);
        
    const addExercise = (e) => sendPostExercise(e, exerciseForm);
      addExerciseBtn.addEventListener("click", addExercise);
      let displayExerciseList = true;
      const getExercises = (e) => {
          if(displayExerciseList) {
          //clear what's in the content so all they see is the list
          exerciseContent.innerHTML="";
          requestUpdate(e, getForm);
          exerciseForm.style.display="none";
          exerciseContent.style.display="block";
          e.target.value="Back to Main";
          addExerciseBtn.disabled = true;
          displayExerciseList = false;
          }
          else {
              exerciseForm.style.display="block";
              content.style.display="none";
              addExerciseBtn.disabled = false;
              e.target.value="Show List";
              displayExerciseList = true;
          }
      };
      getExerciseBtn.addEventListener("click", getExercises);
    };

    window.onload = init;
  </script>
</head>
<body>
    <section id="intro">
    <h1>Wellness Tracker</h1>
        <p>Welcome! Use this wellness tracker to keep track of your goals for the day. Enter your food and water intake, physical activity, and rest. You can edit your goals at any time.</p>
    </section>
    
  <section id="top">
    <div id="div1" class="boxes">  
    <p class="goal">Goal: XX <img src="/edit.png" width="20" height="20" alt="editGoal"/></p>
    <p class="currTotal">Current Total : XX</p>
    <form id="foodForm" action="/addFood" method="post" >
      <p><label for="foodName">Food Name: </label>
      <input id="foodNameField" type="text" name="foodName" />
      </p>
        <p>
      <label for="calories">Calories Per Serving: </label>
      <input id="caloriesField" type="number" name="calories" min="0" max="10000" step="1"/>
        </p>
     <p>
      <label for="quantity">Servings Quantity: </label>
      <input id="quantityField" type="number" name="quantity" min="1" max="30" step=".5"/>
    </p>
    </form> 
     <p>
      <input id="addFoodBtn" type="button" value="Add Food"/>
        <input id="getFoodBtn" type="button" value="Show List" />
    </p>
    <section id="content"></section>
    </div>
      
    <div id="div2" class="boxes">
        <p class="goal">Goal: XX <img src="/edit.png" width="20" height="20" alt="editGoal"/></p>
        <p class="currTotal">Current Total : XX</p>
    <form id="waterForm" action="/addWater" method="post">
      <p><label for="glassesNum">Number of Glasses: </label>
      <input id="glassesNumField" type="number" name="glassesNum" min="1" max="15" step="1"/></p>
      <p><input type="submit" value="Add Glass" /></p>
    </form> 
    <span class="log">Log: </span>
    </div>
      
    </section>
    
    <section id="bottom">
    <div id="div3" class="boxes">
        <p class="goal">Goal: XX <img src="/edit.png" width="20" height="20" alt="editGoal"/></p>
        <p class="currTotal">Current Total : XX</p>
    <form id="exerciseForm" action="/addExercise" method="post">
      <p><label for="exerciseType">Exercise Type: </label>
      <input id="exerciseTypeField" type="text" name="exerciseType" /></p>
      <p><label for="minutes">Duration (Minutes): </label>
      <input id="minutesField" type="number" name="minutes" min="0" max="600" step="1"/></p>
    </form>
    <p>
      <input id="addExerciseBtn" type="button" value="Add Exercise"/>
        <input id="getExerciseBtn" type="button" value="Show List" />
    </p>
    <section id="exerciseContent"></section>
    </div>
      
    <div id="div4" class="boxes">
        <p class="goal">Goal: XX <img src="/edit.png" width="20" height="20" alt="editGoal"/></p>
        <p class="currTotal">Current Total : XX</p>
    <form id="restForm" action="/addRest" method="post">
      <p><label for="sleep">Sleep (Hours): </label>
      <input id="sleepField" type="number" name="sleep" min="0" max="24" step=".5"/></p>
      <p><label for="relaxation">Relaxation Time (Minutes): </label>
      <input id="relaxationField" type="number" name="relaxation" min="0" max="600" step="1"/></p>
      <p><label for="mood">Mood: </label>
      <input id="moodField" type="text" name="mood" /></p>
      <p><input type="submit" value="Add Rest" /></p>
    </form> 
    <span class="log">Log: </span>
      </div>
        
    </section>
      
      <br>
    
    <form id="getForm" action="/getFoods" method="get">
      <select id='urlField'>
        <option value='/getFoods'>/getFoods</option>
        <option value='/notReal'>/notReal</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
    </form>
</body>
</html>