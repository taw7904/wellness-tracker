<!DOCTYPE html>
<html lang="en">
<head>
  <title>Wellness Tracker</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">
    const content = document.querySelector('#content');
    const foodContent = document.querySelector('#foodContent');
    const exerciseContent = document.querySelector('#exerciseContent');

const parseJSON = (xhr, content) => {
  // parse response (obj will be empty in a 204 updated)
  const obj = JSON.parse(xhr.response);
  if (obj.message) {
    const p = document.createElement('p');
    p.textContent = `${obj.message}`;
    content.appendChild(p);
  }

  if (obj.foods) {
    const foodList = document.createElement('ul');
    const foodObj = obj.foods;
    for (const [key, value] of Object.entries(foodObj)) {
      const foodListItem = document.createElement('li');
      foodListItem.innerHTML = `<b>${value.foodName}:</b> ${value.quantity} @ ${value.calories} calories each`;
      foodList.appendChild(foodListItem);
    }
    foodContent.appendChild(foodList);
  }

  if (obj.exercises) {
    const exerciseList = document.createElement('ul');
    const exerciseObj = obj.exercises;
    for (const [key, value] of Object.entries(exerciseObj)) {
      const exerciseListItem = document.createElement('li');
      exerciseListItem.innerHTML = `<b>${value.exerciseType}</b> for ${value.duration} minutes`;
      exerciseList.appendChild(exerciseListItem);
    }
    exerciseContent.appendChild(exerciseList);
  }
};

let foodNameField;
let caloriesField;
let quantityField;
let exerciseTypeField;
let minutesField;

// function to handle our response
const handleResponse = (xhr, parseResponse, buttonType) => {
    if(buttonType!=null || buttonType!=undefined) {
        //if it's show list button clicked, do nothing
        //we're only sending this parameter if it's a show list button
    }
    else {
    //animation controls - only animate if it was an add button, not show list button
    content.classList.remove('animate__bounceOut', 'animate__delay-1s');
    content.style.display = 'block';
    content.classList.add('animate__animated', 'animate__bounceIn');
    content.addEventListener('animationend', () => {
    content.classList.remove('animate__bounceIn');
    content.classList.add('animate__bounceOut', 'animate__delay-1s');
    });
    }
    
  switch (xhr.status) {
    case 200: // success
      // just show the list
      // content.innerHTML = `<b>Success</b>`;
      break;
    case 201: // created
      content.innerHTML = '<b>Added to log!</b>';
      break;
    case 204: // updated (no response back from server)
      content.innerHTML = '<b>Log updated!</b>';
      return;
    case 400: // bad request
      content.innerHTML = '<b>Bad Request</b>';
      break;
    case 404: // not found
      content.innerHTML = '<b>Not Found</b>';
      break;
    default: // our default is not found, but just keeping this in case
      content.innerHTML = 'Error code not implemented by client.';
      break;
  }
  // parse response - only parse if it's NOT a header request
  if (parseResponse) {
    parseJSON(xhr, content);
  }
};

const checkFoodInput = (formName) => {
    foodNameField = formName.querySelector('#foodNameField');
    caloriesField = formName.querySelector('#caloriesField');
    quantityField = formName.querySelector('#quantityField');
}

const checkExerciseInput = (formName) => {
    exerciseTypeField = formName.querySelector('#exerciseTypeField');
    minutesField = formName.querySelector('#minutesField');
}

const foodFormData = () => {
    return `foodName=${foodNameField.value}&calories=${caloriesField.value}&quantity=${quantityField.value}`;
}

const exerciseFormData = () => {
    return `exerciseType=${exerciseTypeField.value}&duration=${minutesField.value}`;
}

// function to send our post request
const sendPost = (e, formName) => {
    let contentArea, formData;
    //if the enter key is triggering it, it wont have the button data set
    if(!e.srcElement.dataset.contentarea) {
        contentArea = document.querySelector(e.path[2].dataset.contentarea);
    }
    //otherwise, grab it from the button dataset
    else {
        contentArea = document.querySelector(e.srcElement.dataset.contentarea);
    }
    
  contentArea.innerHTML = '';
  // grab the forms action (url to go to) and method
  const formAction = formName.getAttribute('action');
  const formMethod = formName.getAttribute('method');

  // grab the food form input
    if(formName.id==='foodForm') {
    checkFoodInput(formName);
    }
    else if(formName.id==='exerciseForm') {
        checkExerciseInput(formName);
    }

  // create a new Ajax request (remember this is asynchronous)
  const xhr = new XMLHttpRequest();
  xhr.open(formMethod, formAction);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.setRequestHeader('Accept', 'application/json');
  xhr.onload = () => handleResponse(xhr, true);

    //build the proper query string of data
   if(formName.id==='foodForm') {
       formData = foodFormData();
   }
    else if(formName.id==='exerciseForm') {
        formData = exerciseFormData();
    }
    
  // send our request with the data
  xhr.send(formData);
  if (e) {
    e.preventDefault();
  }
  // clear the fields in form when done
  formName.reset();
  // set focus back to first input
  formName.elements[0].focus();
  contentArea.style.display = 'block';
  return false;
};

const requestUpdate = (e, formURL, formMethod) => {
    //if its equal to "get" in first 3 strings, do animation
  const url = formURL;
  const method = formMethod;
  const xhr = new XMLHttpRequest();
  xhr.open(method, url);
  xhr.setRequestHeader('Accept', 'application/json');

  if (method == 'get') {
    // if getting data, parse request to get json
    xhr.onload = () => handleResponse(xhr, true, e.target.id);
  } else {
    // HEAD request for no parse, no body responses
    // set onload to check meta data and NOT message
    xhr.onload = () => handleResponse(xhr, false, e.target.id);
  }
  xhr.send();
  e.preventDefault();
  return false;
};



const init = () => {
  // food form elements
  const foodForm = document.querySelector('#foodForm');
  const addFoodBtn = document.querySelector('#addFoodBtn');
  const getFoodBtn = document.querySelector('#getFoodBtn');
  // exercise form elements
  const exerciseForm = document.querySelector('#exerciseForm');
  const addExerciseBtn = document.querySelector('#addExerciseBtn');
  const getExerciseBtn = document.querySelector('#getExerciseBtn');
  //make sure status code is hidden because there is a background color
  content.style.display = 'none';
    
  //set up the input fields so that whenever enter is clicked, it triggers the right form action
  const setUpInputs = (form) => {
    for (let i = 0; i < form.elements.length; i++) {
    let inputField = form.elements[i];
    inputField.addEventListener('keydown', (e) => {
      if (e.keyCode === 13) {
          if(form.id === 'foodForm') {
              addFood(e);
          }
          else if(form.id === 'exerciseForm') {
              addExercise(e);
          }
      }
    });
  }
};
    setUpInputs(foodForm);
    setUpInputs(exerciseForm);

  // create handler
  const addFood = (e) => sendPost(e, foodForm);
  addFoodBtn.addEventListener('click', addFood);
  let displayList = true;
  const getList = (e) => {
    let urlString = e.srcElement.dataset.url;
    let contentArea = document.querySelector(e.srcElement.dataset.contentarea);
    let formName = document.querySelector(e.srcElement.dataset.formname);
    let addButton = document.querySelector(e.srcElement.dataset.addbutton);
    if (displayList) {
      // clear what's in the content so all they see is the list
      contentArea.innerHTML = '';
      requestUpdate(e, urlString, 'get');
      formName.style.display = 'none';
      contentArea.style.display = 'block';
      e.target.value = 'Back to Main';
      addButton.disabled = true;
      displayList = false;
    } else {
      formName.style.display = 'block';
      contentArea.style.display = 'none';
      addButton.disabled = false;
      e.target.value = 'Show List';
      displayList = true;
    }
  };
  getFoodBtn.addEventListener('click', getList);

  const addExercise = (e) => sendPost(e, exerciseForm);
  addExerciseBtn.addEventListener('click', addExercise);
  getExerciseBtn.addEventListener('click', getList);
};

window.onload = init;
    </script>
</head>
<body>
    <section id="intro">
    <h1>Wellness Tracker</h1>
        <p>Welcome! Use this wellness tracker to keep track of your goals for the day. Enter your food and water intake, physical activity, and rest. You can edit your goals at any time.</p>
    </section>
    
  <section id="top">
    <div id="div1" class="boxes">  
    <p class="goal">Food Goal: XX <img src="/edit.png" width="20" height="20" alt="editGoal"/></p>
    <p class="currTotal">Current Total : XX</p>
    <form id="foodForm" action="/addFood" method="post" data-contentarea="#foodContent">
      <p><input id="foodNameField" type="text" name="foodName" placeholder="Food Name"/></p>
      <p><input id="caloriesField" type="number" name="calories" min="0" max="10000" step="1" placeholder="Calories Per Serving"/></p>
      <p><input id="quantityField" type="number" name="quantity" min="1" max="30" step=".5" placeholder="Servings Quantity"/></p>
    </form> 
     <p>
      <input id="addFoodBtn" type="button" value="Add Food" data-contentarea="#foodContent"/>
      <input id="getFoodBtn" type="button" value="Show List" data-url="/getFoods" data-contentarea="#foodContent" data-formname="#foodForm" data-addbutton="#addFoodBtn"/>
    </p>
    <section id="foodContent"></section>
    </div>
      
    <div id="div2" class="boxes">
        <p class="goal">Water Goal: XX <img src="/edit.png" width="20" height="20" alt="editGoal"/></p>
        <p class="currTotal">Current Total : XX</p>
    <form id="waterForm" action="/addWater" method="post">
      <p><input id="glassesNumField" type="number" name="glassesNum" min="1" max="15" step="1" placeholder="Number of Glasses"/></p>
      <p><input type="submit" value="Add Glass" /></p>
    </form> 
    </div>
      
    </section>
    
    <section id="bottom">
    <div id="div3" class="boxes">
        <p class="goal">Exercise Goal: XX <img src="/edit.png" width="20" height="20" alt="editGoal"/></p>
        <p class="currTotal">Current Total : XX</p>
    <form id="exerciseForm" action="/addExercise" method="post" data-contentarea="#exerciseContent">
      <p><input id="exerciseTypeField" type="text" name="exerciseType" placeholder="Exercise Type"/></p>
      <p><input id="minutesField" type="number" name="minutes" min="0" max="600" step="1" placeholder="Duration (Minutes)"/></p>
    </form>
    <p>
      <input id="addExerciseBtn" type="button" value="Add Exercise" data-contentarea="#exerciseContent"/>
        <input id="getExerciseBtn" type="button" value="Show List" data-url="/getExercise" data-contentarea="#exerciseContent" data-formname="#exerciseForm" data-addbutton="#addExerciseBtn"/>
    </p>
    <section id="exerciseContent"></section>
    </div>
      
    <div id="div4" class="boxes">
        <p class="goal">Sleep Goal: XX <img src="/edit.png" width="20" height="20" alt="editGoal"/></p>
        <p class="currTotal">Current Total : XX</p>
    <form id="restForm" action="/addRest" method="post">
      <p><input id="sleepField" type="number" name="sleep" min="0" max="24" step=".5" placeholder="Sleep (Hours)"/></p>
      <p><input id="relaxationField" type="number" name="relaxation" min="0" max="600" step="1" placeholder="Relaxation Time"/></p>
      <p><input id="moodField" type="text" name="mood" placeholder="Mood"/></p>
      <p><input type="submit" value="Add Rest" /></p>
    </form> 
      </div>
    </section>
    
    <section id="content"></section>
</body>
</html>