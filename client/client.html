<!DOCTYPE html>
<html lang="en">
<head>
  <title>Wellness Tracker</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">
    const content = document.querySelector('#content');

    const parseJSON = (xhr, content) => {
      //parse response (obj will be empty in a 204 updated)
      const obj = JSON.parse(xhr.response);
      console.dir(obj);
      
      //if message in response, add to screen
      if(obj.message) {
        const p = document.createElement('p');
        p.textContent = `${obj.message}`;
        content.appendChild(p);
      }
      
      //if users in response, add to screen
      /*if(obj.users) {
        const userList = document.createElement('p');
        const users = JSON.stringify(obj.users);
        userList.textContent = users;
        content.appendChild(userList);
      }*/
        
      if(obj.foods) {
        const foodList = document.createElement('p');
          const foodObj = obj.foods;
          //want to parse it again here so that we can use it
        //const foods = JSON.stringify(obj.foods);
        //foodList.textContent = foods;
          //console.log(foods)
        /*for(let foodItem in foodObj) {
            console.log(foodItem[0]);
            foodList.innerHTML = foodItem + '<br>';
        }*/
          //console.log(Object.keys(foodObj));
          //console.log(Object.keys(foodObj[0]));
          //console.log(foodObj[0]);
        for (const [key, value] of Object.entries(foodObj)) {
            console.log(`${key}: ${value}`);
            }
        content.appendChild(foodList);
      }
    };

    //function to handle our response
    const handleResponse = (xhr, parseResponse) => {
      
      
      //check the status code
      switch(xhr.status) {
        case 200: //success
          //just show the list
          //content.innerHTML = `<b>Added to log!</b>`;
          break;
        case 201: //created
          content.innerHTML = '<b>Added to log!</b>';
          break;
        case 204: //updated (no response back from server)
          content.innerHTML = '<b>Log updated!</b>';
          return;
        case 400: //bad request
          content.innerHTML = `<b>Bad Request</b>`;
          break;
        case 404: //not found
          content.innerHTML = `<b>Not Found</b>`;
          break;
        default: //our default is not found, but just keeping this in case
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }
     //parse response - only parse if it's NOT a header request
        if(parseResponse) {
            parseJSON(xhr, content);
        }
    };

    //function to send our post request
    const sendPost = (e, foodForm) => {
      //grab the forms action (url to go to)
      //and method (HTTP method - POST in this case)
      const foodAction = foodForm.getAttribute('action');
      const foodMethod = foodForm.getAttribute('method');
      
      //grab the form's name and age fields so we can check user input
      const foodNameField = foodForm.querySelector('#foodNameField');
      const caloriesField = foodForm.querySelector('#caloriesField');
      const quantityField = foodForm.querySelector('#quantityField');
      
      //create a new Ajax request (remember this is asynchronous)
      const xhr = new XMLHttpRequest();
      xhr.open(foodMethod, foodAction);
      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader ('Accept', 'application/json');
      xhr.onload = () => handleResponse(xhr, true);
      
      //build our x-www-form-urlencoded format.
      //query string format: key=value&key2=value2
      const formData = `foodName=${foodNameField.value}&calories=${caloriesField.value}&quantity=${quantityField.value}`;
      
      //send our request with the data
      xhr.send(formData);
      e.preventDefault();
      return false;
    };

    const requestUpdate = (e, foodForm) => {
      const url = foodForm.querySelector('#urlField').value;
      const method = foodForm.querySelector('#methodSelect').value;
      const xhr = new XMLHttpRequest();
      xhr.open(method, url); 
      xhr.setRequestHeader('Accept', 'application/json');

      if(method == 'get') {
        //if getting data, parse request to get json
        xhr.onload = () => handleResponse(xhr, true);
      } else {
        // HEAD request for no parse, no body responses
        // set onload to check meta data and NOT message
        xhr.onload = () => handleResponse(xhr, false);
      }
      xhr.send();
      e.preventDefault();
      return false;
    };

    const init = () => {
      //grab form
      const foodForm = document.querySelector('#foodForm');
      const addFoodBtn = document.querySelector("#addFoodBtn");
      const getFoodBtn = document.querySelector("#getFoodBtn");
      //create handler
      const addFood = (e) => sendPost(e, foodForm);
      //attach submit event (for clicking submit or hitting enter)
      //foodForm.addEventListener('submit', addFood);
      addFoodBtn.addEventListener("click", addFood);
      let displayList = true;
      //grab form
      //const getForm = document.querySelector('#getForm');
      //create handler
      const getFoods = (e) => {
          if(displayList) {
          //clear what's in the content so all they see is the list
          content.innerHTML="";
          requestUpdate(e, getForm);
          foodForm.style.display="none";
          content.style.display="block";
          e.target.value="Back to Main";
          displayList = false;
          }
          else {
              foodForm.style.display="block";
              content.style.display="none";
              e.target.value="Show List";
              displayList = true;
          }
      };
      //attach submit event (for clicking submit or hitting enter)
      //getForm.addEventListener('submit', getFoods);
      
      getFoodBtn.addEventListener("click", getFoods);
    };

    window.onload = init;
  </script>
</head>
<body>
    <section id="intro">
    <h1>Wellness Tracker</h1>
        <p>Welcome! Use this wellness tracker to keep track of your goals for the day. Enter your food and water intake, physical activity, and rest. You can edit your goals at any time.</p>
    </section>
    
  <section id="top">
    <!--<h3>Wellness Tracker</h3>
    <form id="nameForm" action="/addUser" method="post">
      <label for="name">Name: </label>
      <input id="nameField" type="text" name="name" />
      <label for="age">Age: </label>
      <input id="ageField" type="number" name="age" min="0" max="100" step="1"/>
      <input type="submit" value="Add User" />
    </form>
      -->
    <div id="div1" class="boxes">  
    <p class="goal">Goal: XX</p>
    <form id="foodForm" action="/addFood" method="post">
      <p><label for="foodName">Food Name: </label>
      <input id="foodNameField" type="text" name="foodName" />
      </p>
        <p>
      <label for="calories">Calories: </label>
      <input id="caloriesField" type="number" name="calories" min="0" max="10000" step="1"/>
        </p>
     <p>
      <label for="quantity">Quantity: </label>
      <input id="quantityField" type="number" name="quantity" min="1" max="30" step=".5"/>
    </p>
    </form> 
     <p>
      <input id="addFoodBtn" type="button" value="Add Food"/>
        <input id="getFoodBtn" type="button" value="Show List" />
    </p>
    <section id="content"></section>
    </div>
      
    <div id="div2" class="boxes">
        <p class="goal">Goal: XX</p>
    <form id="waterForm" action="/addWater" method="post">
      <p><label for="glassesNum">Number of Glasses: </label>
      <input id="glassesNumField" type="number" name="glassesNum" min="1" max="15" step="1"/></p>
      <p><input type="submit" value="Add Glass" /></p>
    </form> 
    <span class="log">Log: </span>
    </div>
      
    </section>
    
    <section id="bottom">
    <div id="div3" class="boxes">
        <p class="goal">Goal: XX</p>
    <form id="exerciseForm" action="/addExercise" method="post">
      <p><label for="exerciseType">Exercise Type: </label>
      <input id="exerciseTypeField" type="text" name="exerciseType" /></p>
      <p><label for="minutes">Duration (Minutes): </label>
      <input id="minutesField" type="number" name="minutes" min="0" max="600" step="1"/></p>
      <p><input type="submit" value="Add Exercise" /></p>
    </form>
    <span class="log">Log: </span>
    </div>
      
    <div id="div4" class="boxes">
        <p class="goal">Goal: XX</p>
    <form id="restForm" action="/addRest" method="post">
      <p><label for="sleep">Sleep (Hours): </label>
      <input id="sleepField" type="number" name="sleep" min="0" max="24" step=".5"/></p>
      <p><label for="relaxation">Relaxation Time (Minutes): </label>
      <input id="relaxationField" type="number" name="relaxation" min="0" max="600" step="1"/></p>
      <p><label for="mood">Mood: </label>
      <input id="moodField" type="text" name="mood" /></p>
      <p><input type="submit" value="Add Rest" /></p>
    </form> 
    <span class="log">Log: </span>
      </div>
        
    </section>
      
      <br>
    
    <form id="getForm" action="/getFoods" method="get">
      <select id='urlField'>
        <option value='/getFoods'>/getFoods</option>
        <option value='/notReal'>/notReal</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <!--<input type="submit" value="Get Foods" />-->
    </form>
    <!--
    <form id="userForm" action="/getUsers" method="get">
      <select id='urlField'>
        <option value='/getUsers'>/getUsers</option>
        <option value='/notReal'>/notReal</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <input type="submit" value="Get User" />
    </form>
    
  <section id="content">
  </section> -->
</body>
</html>